from .. import loader, utils
from asyncio import sleep
import logging
import re

@loader.tds
class BiznesBotMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @good_biznesbob. –ê–≤—Ç–æ—Ä: @TaKaYaMa4a"""

    strings = {
        "name": "GBiznesPro_New",
        "running": "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!",
        "stopped": "üõë –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞",
        "args": "‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö",
        "found": "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: {}",
        "refreshing": "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω—ã...",
        "not_found": "‚ö†Ô∏è –ö–Ω–æ–ø–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
        "owner_skipped": "‚è© –ü—Ä–æ–ø—É—â–µ–Ω —Ä–µ–≥–∏–æ–Ω –≤–ª–∞–¥–µ–ª—å—Ü–∞: {}"
    }

    def __init__(self):
        self.config = loader.ModuleConfig(
            "IGNORE_OWNERS", [], "–°–ø–∏—Å–æ–∫ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è"
        )

    async def client_ready(self, client, db):
        self._db = db
        self._client = client
        self.running = False

    async def _parse_region_message(self, message):
        regions = []
        lines = message.split('\n')
        for line in lines:
            if "–í–ª–∞–¥–µ–ª–µ—Ü:" in line:
                owner = line.split("–í–ª–∞–¥–µ–ª–µ—Ü:")[1].split("\n")[0].strip()
                bonus_match = re.search(r'\+\d+', line)
                bonus = bonus_match.group(0) if bonus_match else None
                if owner and bonus:
                    regions.append({"owner": owner, "bonus": bonus})
        return regions

    async def _find_and_click(self, message):
        while self.running:
            try:
                msgs = await self._client.get_messages("good_biznesbot", limit=5)
                for msg in msgs:
                    if not msg.buttons or not self.running: continue
                    regions = await self._parse_region_message(msg.text)
                    for row in msg.buttons:
                        for button in row:
                            if "üîÆ" in button.text or "üè¢" in button.text: continue
                            if "üçÄ +6" in button.text or "üçÄ +5" in button.text:
                                await button.click()
                                return True, button.text
                await sleep(5)
            except Exception:
                await sleep(5)
        return False, None

    async def bizregcmd(self, message):
        """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è. –ü—Ä–∏–º–µ—Ä: .bizreg 5"""
        args = utils.get_args_raw(message)
        if not args: return await utils.answer(message, self.strings["args"])
        try:
            interval = int(args)
        except: return await utils.answer(message, self.strings["args"])

        self.running = True
        await utils.answer(message, self.strings["running"])
        while self.running:
            await self._client.send_message("good_biznesbot", "/region")
            await sleep(5)
            await self._find_and_click(message)
            await sleep(interval * 60)

    async def bizignorecmd(self, message):
        """–ò–≥–Ω–æ—Ä –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤: .bizignore add –Ω–∏–∫"""
        await utils.answer(message, "–ò–≥–Ω–æ—Ä-–ª–∏—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω (—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)")

    async def bizstopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: .bizstop"""
        self.running = False
        await utils.answer(message, self.strings["stopped"])
