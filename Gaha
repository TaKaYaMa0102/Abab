from .. import loader, utils
from asyncio import sleep
import logging
import re


@loader.tds
class BiznesBotMod(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @good_biznesbob. –ê–≤—Ç–æ—Ä: @TaKaYaMa4a"""

    strings = {
        "name": "GoodBiznesPro",
        "running": "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞! –ò—â–µ–º üçÄ +5/+6...",
        "stopped": "üõë –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞",
        "args": "‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö",
        "found": "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: {}",
        "refreshing": "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–≥–∏–æ–Ω—ã...",
        "not_found": "‚ö†Ô∏è –ö–Ω–æ–ø–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑",
        "crystal_skipped": "‚è© –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–º: {}",
        "building_skipped": "‚è© –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å–æ –∑–¥–∞–Ω–∏–µ–º: {}",
        "owner_skipped": "‚è© –ü—Ä–æ–ø—É—â–µ–Ω —Ä–µ–≥–∏–æ–Ω –≤–ª–∞–¥–µ–ª—å—Ü–∞: {}",
        "searching": "üîç –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫ –∫–Ω–æ–ø–æ–∫...",
        "ignore_set": "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü –≤ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç: {}",
        "ignore_removed": "‚ùå –£–¥–∞–ª–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü –∏–∑ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–∞: {}",
        "ignore_list": "üìã –ò–≥–Ω–æ—Ä-–ª–∏—Å—Ç –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤: {}",
        "ignore_clear": "üßπ –ò–≥–Ω–æ—Ä-–ª–∏—Å—Ç –æ—á–∏—â–µ–Ω"
    }

    def __init__(self):
        self.config = loader.ModuleConfig(
            "IGNORE_OWNERS", [], "–°–ø–∏—Å–æ–∫ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è"
        )

    async def client_ready(self, client, db):
        self._db = db
        self._client = client
        self.running = False

    async def parse_region_message(self, message):
        """–ü–∞—Ä—Å–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–≥–∏–æ–Ω–∞–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤"""
        regions = []
        lines = message.split('\n')
        
        for line in lines:
            if "–í–ª–∞–¥–µ–ª–µ—Ü:" in line:
                owner = line.split("–í–ª–∞–¥–µ–ª–µ—Ü:")[1].split("\n")[0].strip()
                bonus_match = re.search(r'\+\d+', line)
                bonus = bonus_match.group(0) if bonus_match else None
                price_match = re.search(r'–¶–µ–Ω–∞: ([\d\.]+[k–º]*)', line)
                price = price_match.group(1) if price_match else None
                income_match = re.search(r'–î–æ–±—ã—á–∞: \+([\d\.]+[k–º]*)', line)
                income = income_match.group(1) if income_match else None
                
                if owner and bonus and price and income:
                    regions.append({
                        "owner": owner,
                        "bonus": bonus,
                        "price": price,
                        "income": income
                    })
        
        return regions

    async def find_and_click(self, message):
        """–ü–æ–∏—Å–∫ –∏ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ —Å —É—á–µ—Ç–æ–º –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤"""
        while self.running:
            try:
                msgs = await self._client.get_messages("good_biznesbot", limit=5)
                refreshed = False

                for msg in msgs:
                    if not msg.buttons or not self.running:
                        continue

                    # –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–≥–∏–æ–Ω–∞–º–∏
                    regions = await self.parse_region_message(msg.text)
                    
                    # –ò—â–µ–º üçÄ +6 –∏–ª–∏ üçÄ +5 (–±–µ–∑ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞, –∑–¥–∞–Ω–∏–π –∏ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤)
                    for row in msg.buttons:
                        for button in row:
                            if not self.running:
                                return False, None
                                
                            if "üîÆ" in button.text:
                                continue
                            
                            if "üè¢" in button.text:
                                continue
                            
                            if "üçÄ +6" in button.text or "üçÄ +5" in button.text:
                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ–≥–∏–æ–Ω–∞
                                button_index = msg.buttons.index(row) * len(row) + row.index(button)
                                if regions and button_index < len(regions):
                                    region = regions[button_index]
                                    if region["owner"] in self.config["IGNORE_OWNERS"]:
                                        await utils.answer(message, self.strings["owner_skipped"].format(region["owner"]))
                                        continue
                                
                                await button.click()
                                return True, button.text

                    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ - –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
                    if not refreshed:
                        for row in msg.buttons:
                            for button in row:
                                if not self.running:
                                    return False, None
                                    
                                if "üîÆ" in button.text or "üè¢" in button.text:
                                    continue
                                
                                if "–æ–±–Ω–æ–≤–∏—Ç—å" in button.text.lower():
                                    await button.click()
                                    await sleep(3)
                                    refreshed = True
                                    break
                            if refreshed:
                                break

                await sleep(5)

            except Exception as e:
                logging.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–Ω–æ–ø–æ–∫")
                await sleep(5)
                
        return False, None

    async def regioncmd(self, message):
        """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è /region. –ò—Å–ø–æ–ª—å–∑—É–π: .region <–∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö>"""
        args = utils.get_args_raw(message)

        if not args:
            return await utils.answer(message, self.strings["args"])

        try:
            interval = int(args)
        except ValueError:
            return await utils.answer(message, self.strings["args"])

        if self.running:
            self.running = False
            await utils.answer(message, self.strings["stopped"])
            await sleep(1)

        self.running = True
        await utils.answer(message, self.strings["running"])

        while self.running:
            try:
                await self._client.send_message("good_biznesbot", "/region")
                await sleep(5)
                success, button_text = await self.find_and_click(message)
                
                if not self.running:
                    break
                    
                if success:
                    await utils.answer(message, self.strings["found"].format(button_text))
                else:
                    await utils.answer(message, self.strings["not_found"])

                await sleep(interval * 60)

            except Exception as e:
                await utils.answer(message, f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}")
                self.running = False

    async def bignorecmd(self, message):
        """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥–Ω–æ—Ä-–ª–∏—Å—Ç–æ–º –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤. –ò—Å–ø–æ–ª—å–∑—É–π: .ignore add/remove/list/clear <–Ω–∏–∫>"""
        args = utils.get_args_raw(message)
        if not args:
            return await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: add/remove/list/clear <–Ω–∏–∫>")

        parts = args.split(" ", 1)
        action = parts[0].lower()
        owner = parts[1] if len(parts) > 1 else None

        if action == "add" and owner:
            if owner not in self.config["IGNORE_OWNERS"]:
                self.config["IGNORE_OWNERS"].append(owner)
                await utils.answer(message, self.strings["ignore_set"].format(owner))
        elif action == "remove" and owner:
            if owner in self.config["IGNORE_OWNERS"]:
                self.config["IGNORE_OWNERS"].remove(owner)
                await utils.answer(message, self.strings["ignore_removed"].format(owner))
        elif action == "list":
            owners = ", ".join(self.config["IGNORE_OWNERS"]) if self.config["IGNORE_OWNERS"] else "–ø—É—Å—Ç"
            await utils.answer(message, self.strings["ignore_list"].format(owners))
        elif action == "clear":
            self.config["IGNORE_OWNERS"] = []
            await utils.answer(message, self.strings["ignore_clear"])
        else:
            await utils.answer(message, "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π: .ignore add/remove/list/clear <–Ω–∏–∫>")

    async def stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é"""
        self.running = False
        await utils.answer(message, self.strings["stopped"])
